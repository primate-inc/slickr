# Megadraft

## Extending Megadraft

In text editing mode, Megadraft has a range of options such as bold, italic,
bullet list, etc.  With this editor there is also the ability to add icons to
the toolbar that can display info from your models.

When you run the generator, you will see that a new folder has been added to
the ``` app/javascript ``` folder called ``` slickr_extensions ```. Additionally,
a new model is added under ``` app/models/slickr/page.rb ```.

In ``` app/models/slickr/page.rb ``` you can add to ``` additional_page_edit_paths ```
to include new methods to get info from a model. There is currently an example
method ``` admin_user_index_path ``` which requests the admin index path and has
params of ``` type: 'megadraft_admins') ```.

When the icon is clicked in the Megadraft toolbar, this path will be requested
which requires the controller action to be added to Active Admin AdminUser. For
example add:

```ruby
controller do
  def index
    if params[:type] == 'megadraft_admins'
      @admins = AdminUser.all
      index! do |format|
        format.html { render :json => @admins.to_json }
      end
    else
      index!
    end
  end
end
```

making sure the params match.

### Extending Redux store

In ``` slickr_extensions/page_edit/containers/additional_prop_types.js ``` the
propTypes are extended with our default but you can add to this as needed.

Next we need to handle state change which is done through ``` slickr_extensions/page_edit/reducers/additional_reducers.js ```. Again this is
based on our admins example and simply references a function that responds
to ``` LOAD_ADMINS ``` to get the payload from the admin controller we added above.

The action to trigger this state change is at ``` slickr_extensions/page_edit/actions/additional_actions.js ```.

### Custom Entities

See [Megadraft custom entities](https://github.com/globocom/megadraft/blob/master/docs/custom_entities.md)
for more info.

Megadraft ships with a default entity "LINK" and an according action in the toolbar that allows a user to type in an url. We are adding to it with "ADMIN_LINK" with an action that allows a user to select
an admin email. We extend the entity inputs from ``` slickr_extensions/page_edit/components/content/additional_entity_inputs.js ``` and
agin you can add more as needed.

In order to render the custom entities, we need to define decorators as seen
in ``` slickr_extensions/page_edit/actions/additional_actions.js ```. Upon
highlighting text in the Megadraft editor and then clicking the admin
icon in the Megadraft toolbar, componentWillMount() is fired which in
this case is used to signify a state change in Megadraft and passes ```editorState```
as "load_admins" which is handled in ``` slickr_extensions/page_edit/components/content/editor_state_change.js ```.

The action we setup above to load the admins is now fired and the render method
of entity input is called. This renders a drop down menu on the screen and an
array of admins with a value as a fake link and label of their email populates the drop down.

The value of ``` this.props.url ``` in

```javascript
<Select
  name="form-field-name"
  value={this.props.url}
  options={admins}
  onChange={this.onAdminChange}
/>
```

at this point is undefined but when an admin email is clicked, the rendering in
the editor is handled by ``` slickr_extensions/page_edit/decorators/admin_link_component.jsx ```.
The text you highlighted earlier is now wrapped with a link with an href of
the link you declared in the value of the drop down. The value of ``` this.props.url ```
is now the href value.

## Megadraft to HTML

The content generated by Megadraft needs to be converted to HTML to be displayed
in preview mode or in the front end. If you have added any custom entities you will
need to add to "DRAFTJS_CONFIG" in ``` app/models/slickr/page.rb ``` by adding

``` ruby
'ADMIN_LINK' => DraftjsExporter::Entities::Link.new(className: 'admin__link')
```

for our example in "entity_decorators".

### Page Layouts

For each page you create, you will select a page layout. We have included some
defaults in ``` app/models/slickr/page.rb ``` in the "LAYOUTS" constant but you
can remove or add as many as you like.

For each layout listed in "LAYOUTS" you will need a corresponding file
at ``` app/views/slickr_page_templates ``` with the same name like ``` contact.html.erb```
or ``` contact.slim ```.

The instance variable is accessed as ``` slickr_page``` and the megadraft content
as ``` raw content ```. So as a simple example the page could look as follows:

``` html
<h1><%= page["title"] %></h1>
<p><%= page["page_intro"] %></p>
<%= raw content %>
```

## Megadraft Text Area

Slickr enables the Megadraft editor to be used in text area inputs which normal
Active Admin resources. Below is an example for how to have a mix of normal
text area fields and megadraft text areas:

```ruby
form do |f|
  f.inputs do
    f.input :title
    f.input :body_normal,
            as: :text
    render 'admin/form/text_area_helper', f: f, field: :body_megadraft
    f.input :body_megadraft,
            as: :text
  end
  f.actions
end
```

### View Helper

In order to use the DraftJS output from Megadraft there is a helper available to
use in your views:

```html
<%= draftjs_to_html(@slickr_page, :body_megadraft) %>
```

replacing the instance variable with that generated in your controller and the
second argument with whatever field has the DraftJS content.

## Adding new context style

To add a new style to your context menu:

1. Add new block to `DRAFTJS_CONFIG` in `app/models/slickr/page.rb`:
```ruby
'two-column' => {
  element: "p",
  wrapper: [
    "div", { className: 'print_columns'}
  ]
}
```
2. Add new block to `app/javascript/slickr_extensions/page_edit/additional_megadraft_block_styles.js`:
```javascript
const additionalBlockStyles = [
  {
    type: 'two-column',
    className: 'print_columns',
  },
];

export default additionalBlockStyles;
```

3. Add new action and icon to `app/javascript/slickr_extensions/page_edit/additional_megadraft_actions.js`:
```javascript
import FaTwoCol from 'react-icons/lib/fa/columns';

...

const additionalActions = [
   { type: "entity", label: "PDF Link", style: "link", entity: "PDF_LINK", icon: FaPdf },
   { type: "block", label: "Two columns", style: "two-column", entity: "TWO_COLUMN", icon: FaTwoCol }
]
```

4. Add some styles to make it distinguishable to `app/assets/stylesheets/active_admin/main.scss`:
```scss
.DraftEditor-editorContainer {
   .print_columns {
     padding: 1em;
     border: 1px solid grey;
   }
}
```
